<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Liveaboard Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
      padding: 24px;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .title {
      font-size: 28px;
      font-weight: 700;
      color: #38bdf8;
    }
    .subtitle {
      font-size: 14px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .simulate-date {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .simulate-date input {
      background: #020617;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .card {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 10px;
      padding: 10px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, #111827 0, #020617 45%, #020617 100%);
      border: 1px solid #111827;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.8);
    }
    .card-left {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      height: 130px;
    }
    .card-left img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .location-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .card-right {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 8px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    .boat-name {
      font-size: 16px;
      font-weight: 600;
    }
    .trip-status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-running { background: rgba(22,163,74,0.15); color: #4ade80; border: 1px solid #22c55e; }
    .status-upcoming { background: rgba(234,179,8,0.1); color: #facc15; border: 1px solid #eab308; }
    .status-finished { background: rgba(148,163,184,0.08); color: #9ca3af; border: 1px solid #6b7280; }
    .trip-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11.5px;
      color: #9ca3af;
    }
    .trip-meta strong { color: #e5e7eb; font-weight: 500; }

    .progress-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: 0;
    }
    .progress-label {
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .dots {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #111827;
      box-shadow: 0 0 0 1px #1f2937;
    }
    .dot-active {
      background: #38bdf8;
      box-shadow: 0 0 0 1px #0ea5e9, 0 0 12px rgba(56, 189, 248, 0.9);
    }
    .dot-finished {
      background: #22c55e;
      box-shadow: 0 0 0 1px #16a34a;
    }
    .day-text {
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }
    .capacity {
      font-size: 12px;
      color: #9ca3af;
    }
    .capacity strong { color: #e5e7eb; }

    .error {
      margin-top: 16px;
      color: #f87171;
      font-size: 14px;
    }

    @media (max-width: 900px) {
      .cards {
        grid-template-columns: 1fr;
      }
      .card {
        grid-template-columns: 1fr;
      }
      .card-left {
        height: 180px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <div class="page-header">
    <div>
      <div class="title">Liveaboard Dashboard</div>
      <div class="subtitle">Real-time boat trip monitoring (from Google Sheets)</div>
    </div>
    <div class="simulate-date">
      <span>Simulate date:</span>
      <input type="date" id="simulate-date" />
    </div>
  </div>

  <div id="cards" class="cards"></div>
  <div id="error" class="error" style="display:none;"></div>
</div>

<script>
  // === CONFIG ของคุณ ===
  // ใช้ลิงก์ publish เป็น CSV เพื่อเลี่ยง 403 (ไม่ต้องพึ่ง API key)
  // ถ้าใช้ลิงก์นี้ไม่ได้ ให้ตรวจสอบว่า publish to web แล้วหรือยัง
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTVRDJ5JQbkKChx1EbxEZ8GP2dRnfJ4_k9KHUx_cOgVICWIh5QcCJCMyc4l5zSGYohd5iY5msvnSijG/pub?gid=907829414&single=true&output=csv";


  function parseDate(d) {
    if (!d) return null;
    const dt = new Date(d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function diffDays(start, end) {
    const msPerDay = 24 * 60 * 60 * 1000;
    return Math.floor((end - start) / msPerDay);
  }

  function getCurrentDayIndex(today, startDate, durationDays) {
    const startMid = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const todayMid = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const offset = diffDays(startMid, todayMid);
    if (offset < 0 || offset >= durationDays) return null;
    return offset + 1;
  }

  // parse CSV text to rows (array of array)
  function parseCsv(text) {
    const lines = text.trim().split(/\r?\n/);
    return lines.map((line) => {
      // simple CSV split that handles quoted commas
      const result = [];
      let current = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }
        if (ch === "," && !inQuotes) { result.push(current); current = ""; continue; }
        current += ch;
      }
      result.push(current);
      return result;
    });
  }

  // ปรับลิงก์รูปจาก Google Drive / GitHub blob ให้เป็น viewable
  function normalizeImage(url) {
    if (!url) return null;
    // Google Drive: https://drive.google.com/file/d/<ID>/view
    const m = url.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)\//i);
    if (m && m[1]) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    // GitHub blob: https://github.com/user/repo/blob/branch/path/to/file.jpg
    const g = url.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/(.+)/i);
    if (g && g[1] && g[2] && g[3]) return `https://raw.githubusercontent.com/${g[1]}/${g[2]}/${g[3]}`;

    return url;
  }

  async function loadTrips(simulatedDate) {
    const cardsContainer = document.getElementById("cards");
    const errorEl = document.getElementById("error");
    cardsContainer.innerHTML = "";
    errorEl.style.display = "none";

    try {
      const res = await fetch(CSV_URL);
      if (!res.ok) throw new Error("Google Sheets fetch error: " + res.status);
      const text = await res.text();
      const rows = parseCsv(text);
      const today = simulatedDate || new Date();

      rows.forEach((row, idx) => {
        const [
          boatName,          // A
          startDateStr,      // B
          endDateStr,        // C
          maxSpacesStr,      // D
          bookedStr,         // E
          durationStr,       // F
          imageLink,         // G (backup ถ้า H ว่าง)
          imageStatic        // H (Image_Static ใช้ค่านี้เป็นหลัก)
        ] = row;

        // ข้าม header แถวแรกถ้ามีคำว่า boat_name
        if (idx === 0 && (boatName || "").toLowerCase() === "boat_name") return;
        if (!boatName || !startDateStr || !durationStr) return;

        const startDate = parseDate(startDateStr);
        let durationDays = parseInt(durationStr, 10);
        if (!durationDays && endDateStr) {
          const endDateTmp = parseDate(endDateStr);
          if (startDate && endDateTmp) {
            durationDays = diffDays(startDate, endDateTmp) + 1;
          }
        }
        if (!startDate || !durationDays) return;

        const endDate = endDateStr
          ? parseDate(endDateStr)
          : new Date(startDate.getTime() + (durationDays - 1) * 86400000);

        const maxSpaces = parseInt(maxSpacesStr || "0", 10);
        const booked = parseInt(bookedStr || "0", 10);

        const todayIndex = getCurrentDayIndex(today, startDate, durationDays);
        const isRunning = todayIndex !== null;
        const isBefore = today < startDate;
        const isAfter  = today > endDate;

        let statusText = "Upcoming";
        let statusClass = "status-upcoming";
        if (isRunning) { statusText = "Running"; statusClass = "status-running"; }
        else if (isAfter) { statusText = "Finished"; statusClass = "status-finished"; }

        const card = document.createElement("div");
        card.className = "card";

        const left = document.createElement("div");
        left.className = "card-left";
        const img = document.createElement("img");
        const mainImg = (imageStatic || "").trim();
        const backupImg = (imageLink || "").trim(); // เผื่อ H ว่างจะลองใช้ G
        const normalizedImg = normalizeImage(mainImg || backupImg);
        img.src = normalizedImg || "https://images.pexels.com/photos/258154/pexels-photo-258154.jpeg?auto=compress&cs=tinysrgb&w=1200";
        img.alt = boatName;
        img.onerror = () => {
          img.src = "https://images.pexels.com/photos/258154/pexels-photo-258154.jpeg?auto=compress&cs=tinysrgb&w=1200";
        };
        left.appendChild(img);

        const loc = document.createElement("div");
        loc.className = "location-badge";
        loc.textContent = "Liveaboard";
        left.appendChild(loc);

        const right = document.createElement("div");
        right.className = "card-right";

        const header = document.createElement("div");
        header.className = "card-header";
        const nameEl = document.createElement("div");
        nameEl.className = "boat-name";
        nameEl.textContent = boatName;
        const statusEl = document.createElement("div");
        statusEl.className = `trip-status ${statusClass}`;
        statusEl.textContent = statusText;
        header.appendChild(nameEl);
        header.appendChild(statusEl);

        const meta = document.createElement("div");
        meta.className = "trip-meta";
        const fmt = (d) => d
          ? d.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })
          : "-";
        const dateSpan = document.createElement("div");
        dateSpan.innerHTML = `<strong>${fmt(startDate)}</strong> - <strong>${fmt(endDate)}</strong>`;
        const durationSpan = document.createElement("div");
        durationSpan.innerHTML = `<strong>${durationDays}</strong> Days`;
        const capacitySpan = document.createElement("div");
        capacitySpan.className = "capacity";
        capacitySpan.innerHTML = `Guests: <strong>${booked}/${maxSpaces || "-"}</strong>`;
        meta.appendChild(dateSpan);
        meta.appendChild(durationSpan);
        meta.appendChild(capacitySpan);

        const progressRow = document.createElement("div");
        progressRow.className = "progress-row";

        const leftCol = document.createElement("div");
        const progressLabel = document.createElement("div");
        progressLabel.className = "progress-label";
        progressLabel.textContent = "Trip Progress";
        const dots = document.createElement("div");
        dots.className = "dots";

        for (let i = 1; i <= durationDays; i++) {
          const dot = document.createElement("div");
          dot.className = "dot";
          if (todayIndex && i < todayIndex) {
            dot.classList.add("dot-finished");
          } else if (todayIndex === i) {
            dot.classList.add("dot-active");
          }
          dots.appendChild(dot);
        }

        leftCol.appendChild(progressLabel);
        leftCol.appendChild(dots);

        const rightCol = document.createElement("div");
        rightCol.className = "day-text";
        if (todayIndex) {
          rightCol.textContent = `Day ${todayIndex} / ${durationDays}`;
        } else if (isBefore) {
          rightCol.textContent = `Starts in ${diffDays(today, startDate) * -1} days`;
        } else {
          rightCol.textContent = `Finished`;
        }

        progressRow.appendChild(leftCol);
        progressRow.appendChild(rightCol);

        right.appendChild(header);
        right.appendChild(meta);
        right.appendChild(progressRow);

        card.appendChild(left);
        card.appendChild(right);
        cardsContainer.appendChild(card);
      });

      if (!rows.length) {
        errorEl.textContent = "No data rows returned from CSV.";
        errorEl.style.display = "block";
      }
    } catch (err) {
      console.error(err);
      errorEl.textContent = err.message;
      errorEl.style.display = "block";
    }
  }

  const dateInput = document.getElementById("simulate-date");
  const todayISO = new Date().toISOString().slice(0, 10);
  dateInput.value = todayISO;
  dateInput.addEventListener("change", () => {
    const d = new Date(dateInput.value);
    if (!isNaN(d.getTime())) loadTrips(d);
  });

  loadTrips(new Date(todayISO));
</script>
</body>
</html>